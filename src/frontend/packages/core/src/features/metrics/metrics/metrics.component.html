<app-page-header [breadcrumbs]="breadcrumbs$ | async">{{ (metricsEndpoint$ | async)?.provider.name }}</app-page-header>

<div *ngIf="(metricsEndpoint$ | async) as ep">
  <mat-card>
    <mat-card-content>
      <div class="metrics-info">
        <mat-icon>equalizer</mat-icon>
        <div>
          <div>{{ ep.provider.name }}</div>
          <h2 class="metrics-url">
            <a target="metrics" href="{{ ep.provider.token_endpoint }}">{{ ep.provider.token_endpoint }}</a>
          </h2>
          <div *ngIf="error">
            <p>This metrics endpoint does not provide a Stratos metadata file</p>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div *ngIf="metricsInfo$ | async as infos">
    <div class="metrics-detail" *ngIf="infos.length === 0">
      <p>This metrics endpoint does not provide data for any endpoints</p>
    </div>
    <div *ngIf="infos.length > 0">
      <div class="metrics-tree__root"></div>
      <ul class="metrics-tree tree">
        <li *ngFor="let info of infos" class="metric-endpoint">
          <!-- Display information about all the data provided by this metrics endpoint via the relations it has with the parent metrics endpoint.
         This covers both configuration for the type of metric collected (defined by the relation's metadata) or the status of the job associated
        with the relation (for instance cf-exporter) -->

          <mat-card class="metrics-provision">
            <app-card-status *ngIf="info.status" [status$]="info.status"></app-card-status>
            <mat-card-content>
              <div class="metrics-info">
                <mat-icon fontSet="{{ info.icon.font }}">{{info.icon.name }}</mat-icon>
                <div class="metrics-metadata">
                  <div>Endpoint: {{ info.name }} ({{ info.type }})</div>
                  <app-metadata-item icon="link" label="Address" [clipboardValue]="info.url">{{ info.url }}
                  </app-metadata-item>
                  <ng-container *ngFor="let relation of info.relations">
                    <div>{{ metadataLabels[relation.type] }}</div>
                    <div class="metrics-metadata__cols">
                      <div class="metrics-metadata__two-cols">
                        <!-- Display information about all metric relations that the parent metrics endpoint is providing this endpoint -->
                        <app-metadata-item *ngFor="let metadataType of metadataTypes[relation.type]"
                          [icon]="metadataType.icon" [iconFont]="metadataType.iconFont" [label]="metadataType.label">
                          {{metadataType.value(relation.metadata) ||  'N/A'}}
                        </app-metadata-item>
                      </div>
                      <div class="metrics-metadata__two-cols">
                        <!-- Display information about all associated metric jobs provided by the parent metrics endpoint to this endpoint -->
                        <div class="metrics-extra"
                          *ngIf="metadataJobTypes[relation.type] && metadataJobTypes[relation.type].length && relation.metadata.job && (jobDetails$ | async) as jobDetails">
                          <div *ngIf="jobDetails[relation.metadata.job] as job">
                            <app-metadata-item *ngFor="let metadataType of metadataJobTypes[relation.type]"
                              [icon]="metadataType.icon" [iconFont]="metadataType.iconFont"
                              [label]="metadataType.label">
                              {{metadataType.value(job) }}</app-metadata-item>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <div *ngIf="!info.known">
                    <div class="metrics-unknown">
                      <mat-icon class="text-warning">warning</mat-icon>
                      <div>The metrics endpoint reports that it provides data for this endpoint which is not registered
                        with Stratos</div>
                    </div>
                    <div class="metrics-unknown__detail">This could be intentional or there may be a mismatch in the
                      endpoint address used by this Metrics endpoint and that which is registered with Stratos.</div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </li>
      </ul>
    </div>
  </div>
</div>