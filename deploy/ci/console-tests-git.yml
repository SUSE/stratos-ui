resources:
- name: stratos-deploy
  type: git
  source:
    uri: git@github.com:hpcloud/stratos-deploy.git
    branch: {{stratos-deploy-branch}}
    private_key: {{github-private-key}}
- name: portal-proxy
  type: git
  source:
    uri: git@github.com:hpcloud/portal-proxy.git
    branch:  {{portal-proxy-branch}}
    private_key: {{github-private-key}}
- name: stratos-ui
  type: git
  source:
    branch: {{stratos-ui-branch}}
    private_key: {{github-private-key}}
    uri: git@github.com:hpcloud/stratos-ui.git

groups:
- name: tests
  jobs:
  - unit-tests
  - e2e-tests

jobs:
- name: unit-tests
  plan:
  - get: stratos-deploy
  - get: portal-proxy
  - get: stratos-ui

  - do:
    - task: run-unit-tests
      privileged: true
      timeout: 5m
      file: stratos-deploy/ci/tasks/stratos-ui/run-unit-tests.yml
- name: e2e-tests
  plan:
  - get: stratos-deploy
    passed: [unit-tests]
  - get: portal-proxy
    passed: [unit-tests]
  - get: stratos-ui
    passed: [unit-tests]

  - do:
    - task: build-proxy-image
      file: stratos-deploy/ci/tasks/stratos-ui/prep-proxy-image.yml
    - task: run-e2e-tests
      privileged: true
      params:
       REGISTRY_NAME: {{insecure-registry}}
       CUSTOM_APP_LABEL: {{custom-app-label}}
      timeout: 10m
      file: stratos-deploy/ci/tasks/stratos-ui/run-tests.yml